{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Ovovex{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white">{{ title }}</h1>
                <p class="text-gray-400 mt-2">Record debits and credits to maintain accurate books</p>
            </div>
            <a href="{% url 'accounting:journal_entry_list' %}"
               class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                <i class="fas fa-arrow-left mr-2"></i>Back to List
            </a>
        </div>

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
            <div class="mb-4 p-4 rounded-lg {% if message.tags == 'success' %}bg-green-800/50 border border-green-600{% elif message.tags == 'error' %}bg-red-800/50 border border-red-600{% else %}bg-blue-800/50 border border-blue-600{% endif %}">
                <p class="text-sm">{{ message }}</p>
            </div>
            {% endfor %}
        {% endif %}

        <!-- Journal Entry Form -->
        <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-700">
            <div class="p-6">
                <form method="post" class="space-y-6">
                    {% csrf_token %}

                    <!-- Entry Header -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Entry Number -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Entry Number <span class="text-red-500">*</span>
                            </label>
                            {{ form.entry_number }}
                            {% if form.entry_number.errors %}
                                <p class="mt-1 text-sm text-red-400">{{ form.entry_number.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Entry Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Entry Date <span class="text-red-500">*</span>
                            </label>
                            {{ form.entry_date }}
                            {% if form.entry_date.errors %}
                                <p class="mt-1 text-sm text-red-400">{{ form.entry_date.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Reference -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Reference
                            </label>
                            {{ form.reference }}
                            {% if form.reference.errors %}
                                <p class="mt-1 text-sm text-red-400">{{ form.reference.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Status -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Status <span class="text-red-500">*</span>
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <p class="mt-1 text-sm text-red-400">{{ form.status.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Description <span class="text-red-500">*</span>
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <p class="mt-1 text-sm text-red-400">{{ form.description.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Line Items -->
                    <div class="border-t border-gray-700 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Journal Entry Lines</h3>
                            <button type="button" id="addLineBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                                <i class="fas fa-plus mr-2"></i>Add Line
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full" id="linesTable">
                                <thead class="bg-gray-900/50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Account</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Description</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase">Debit</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase">Credit</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="linesContainer" class="divide-y divide-gray-700">
                                    <!-- Lines will be added dynamically -->
                                </tbody>
                                <tfoot class="bg-gray-900/50 border-t-2 border-gray-600">
                                    <tr>
                                        <td colspan="2" class="px-4 py-3 text-right font-bold text-white">Totals:</td>
                                        <td class="px-4 py-3 text-right font-bold text-white">
                                            $<span id="totalDebit">0.00</span>
                                        </td>
                                        <td class="px-4 py-3 text-right font-bold text-white">
                                            $<span id="totalCredit">0.00</span>
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr id="balanceRow">
                                        <td colspan="2" class="px-4 py-2 text-right text-sm">
                                            <span id="balanceLabel" class="font-medium"></span>
                                        </td>
                                        <td colspan="3" class="px-4 py-2 text-right">
                                            <span id="balanceAmount" class="text-sm font-medium"></span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <input type="hidden" name="line_count" id="lineCount" value="0">
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-4 border-t border-gray-700 pt-6">
                        <a href="{% url 'accounting:journal_entry_list' %}"
                           class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                            Cancel
                        </a>
                        <button type="submit"
                                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>{{ action }} Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-6 bg-blue-900/30 border border-blue-700 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-blue-300 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Journal Entry Guidelines
            </h4>
            <ul class="text-sm text-blue-200 space-y-1 list-disc list-inside">
                <li>Total debits must equal total credits (double-entry accounting)</li>
                <li>Each entry must have at least two lines (one debit and one credit)</li>
                <li>Use clear descriptions for each line item</li>
                <li>Draft entries can be edited; Posted entries cannot be modified</li>
            </ul>
        </div>
    </div>
</div>

<script>
let lineCounter = 0;
const accounts = {{ accounts|safe }};

function addLine() {
    const container = document.getElementById('linesContainer');
    const row = document.createElement('tr');
    row.className = 'line-row';
    row.innerHTML = `
        <td class="px-4 py-3">
            <select name="line_${lineCounter}_account" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white focus:ring-2 focus:ring-blue-500" required>
                <option value="">Select account...</option>
                ${accounts.map(acc => `<option value="${acc.id}">${acc.code} - ${acc.name}</option>`).join('')}
            </select>
        </td>
        <td class="px-4 py-3">
            <input type="text" name="line_${lineCounter}_description"
                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white focus:ring-2 focus:ring-blue-500"
                   placeholder="Line description">
        </td>
        <td class="px-4 py-3">
            <input type="number" step="0.01" min="0" name="line_${lineCounter}_debit"
                   class="debit-input w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white text-right focus:ring-2 focus:ring-blue-500"
                   placeholder="0.00" value="0.00">
        </td>
        <td class="px-4 py-3">
            <input type="number" step="0.01" min="0" name="line_${lineCounter}_credit"
                   class="credit-input w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white text-right focus:ring-2 focus:ring-blue-500"
                   placeholder="0.00" value="0.00">
        </td>
        <td class="px-4 py-3 text-center">
            <button type="button" onclick="removeLine(this)" class="text-red-500 hover:text-red-400">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    container.appendChild(row);
    lineCounter++;
    updateLineCount();
    updateTotals();

    // Add event listeners to new inputs
    row.querySelectorAll('.debit-input, .credit-input').forEach(input => {
        input.addEventListener('input', updateTotals);
        input.addEventListener('change', enforceDebitOrCredit);
    });
}

function removeLine(button) {
    button.closest('tr').remove();
    updateTotals();
}

function enforceDebitOrCredit(e) {
    const row = e.target.closest('tr');
    const debitInput = row.querySelector('.debit-input');
    const creditInput = row.querySelector('.credit-input');

    if (e.target === debitInput && parseFloat(debitInput.value) > 0) {
        creditInput.value = '0.00';
    } else if (e.target === creditInput && parseFloat(creditInput.value) > 0) {
        debitInput.value = '0.00';
    }

    updateTotals();
}

function updateTotals() {
    let totalDebit = 0;
    let totalCredit = 0;

    document.querySelectorAll('.debit-input').forEach(input => {
        totalDebit += parseFloat(input.value) || 0;
    });

    document.querySelectorAll('.credit-input').forEach(input => {
        totalCredit += parseFloat(input.value) || 0;
    });

    document.getElementById('totalDebit').textContent = totalDebit.toFixed(2);
    document.getElementById('totalCredit').textContent = totalCredit.toFixed(2);

    // Show balance status
    const difference = Math.abs(totalDebit - totalCredit);
    const balanceRow = document.getElementById('balanceRow');
    const balanceLabel = document.getElementById('balanceLabel');
    const balanceAmount = document.getElementById('balanceAmount');

    if (difference < 0.01 && totalDebit > 0) {
        balanceLabel.textContent = 'Status:';
        balanceAmount.textContent = 'Balanced ✓';
        balanceAmount.className = 'text-sm font-medium text-green-400';
    } else if (difference > 0) {
        balanceLabel.textContent = 'Difference:';
        balanceAmount.textContent = `Out of balance by $${difference.toFixed(2)}`;
        balanceAmount.className = 'text-sm font-medium text-red-400';
    } else {
        balanceLabel.textContent = '';
        balanceAmount.textContent = '';
    }
}

function updateLineCount() {
    document.getElementById('lineCount').value = lineCounter;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('addLineBtn').addEventListener('click', addLine);

    // Add initial two lines
    addLine();
    addLine();
});
</script>
{% endblock %}
