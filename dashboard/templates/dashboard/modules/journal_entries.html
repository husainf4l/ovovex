{% extends 'modules/base_module.html' %}
{% load static %}

{% block content %}
{% include 'components/sidemenu.html' %}

<div class="min-h-screen bg-gray-50 dark:bg-gray-900 ml-64 transitio                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {{ entry.reference|default:"-" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">{{ entry.status }}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
                                    ${{ entry.total_debit|floatformat:2 }} duration-300">
    <!-- Top Navigation Bar -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 transition-colors duration-300">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Journal Entries</h1>
                <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm font-medium rounded-full">{{ total_entries }} Total</span>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Quick Search -->
                <div class="relative">
                    <input type="text" placeholder="Search entries..." class="w-64 pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors duration-300">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400 dark:text-gray-500"></i>
                </div>
                <!-- New Entry -->
                <button id="new-entry-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>
                    New Entry
                </button>
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors duration-300">
                    <i class="fas fa-moon text-xl dark:hidden"></i>
                    <i class="fas fa-sun text-xl hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-8">
        <!-- Breadcrumb -->
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'dashboard:dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                        <i class="fas fa-home mr-2"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Journal Entries</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Module Description -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">Journal Entry Management</h2>
                    <p class="text-gray-600 dark:text-gray-400">Record and manage manual journal entries and accounting adjustments. Ensure balanced double-entry bookkeeping.</p>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${{ total_debits|floatformat:0 }}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Total Debits</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400">${{ total_credits|floatformat:0 }}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Total Credits</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <!-- Total Entries -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-book text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <span class="text-blue-600 dark:text-blue-400 text-sm font-medium">All</span>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">{{ total_entries }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Total Entries</div>
            </div>

            <!-- Posted Entries -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
                    </div>
                    <span class="text-green-600 dark:text-green-400 text-sm font-medium">{{ posted_entries }}</span>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">{{ posted_entries }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Posted</div>
            </div>

            <!-- Draft Entries -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-edit text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <span class="text-yellow-600 dark:text-yellow-400 text-sm font-medium">{{ draft_entries }}</span>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">{{ draft_entries }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Drafts</div>
            </div>

            <!-- This Month -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <span class="text-purple-600 dark:text-purple-400 text-sm font-medium">MTD</span>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">${{ total_debits|floatformat:0 }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">This Month</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <button id="new-entry-action-btn" class="flex items-center justify-center px-4 py-3 bg-blue-600 text-white font-medium rounded-xl hover:bg-blue-700 transition-colors duration-200">
                <i class="fas fa-plus mr-2"></i>
                New Entry
            </button>
            <button id="post-entries-btn" class="flex items-center justify-center px-4 py-3 bg-green-600 text-white font-medium rounded-xl hover:bg-green-700 transition-colors duration-200">
                <i class="fas fa-clipboard-check mr-2"></i>
                Post Entries
            </button>
            <button id="reverse-entry-btn" class="flex items-center justify-center px-4 py-3 bg-purple-600 text-white font-medium rounded-xl hover:bg-purple-700 transition-colors duration-200">
                <i class="fas fa-undo mr-2"></i>
                Reverse Entry
            </button>
            <button id="export-btn" class="flex items-center justify-center px-4 py-3 bg-gray-600 dark:bg-gray-700 text-white font-medium rounded-xl hover:bg-gray-700 dark:hover:bg-gray-600 transition-colors duration-200">
                <i class="fas fa-download mr-2"></i>
                Export
            </button>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Journal Entries List -->
            <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">All Journal Entries</h3>
                        <div class="flex items-center space-x-2">
                            <select class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors duration-300">
                                <option>All Types</option>
                                <option>Standard</option>
                                <option>Adjusting</option>
                                <option>Closing</option>
                                <option>Reversing</option>
                            </select>
                            <select class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors duration-300">
                                <option>All Status</option>
                                <option>Posted</option>
                                <option>Draft</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Entry #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Reference</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Debit</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Credit</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for entry in journal_entries %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 dark:text-blue-400">
                                    <a href="#" class="hover:underline">JE-{{ entry.id|stringformat:"04d" }}</a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {{ entry.entry_date|date:"M d, Y" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                    {{ entry.reference|default:"-" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">{{ entry.entry_type }}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
                                    ${{ entry.total_debit|floatformat:2 }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
                                    ${{ entry.total_credit|floatformat:2 }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if entry.status == 'POSTED' %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                        <i class="fas fa-check mr-1"></i>Posted
                                    </span>
                                    {% else %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                                        <i class="fas fa-edit mr-1"></i>Draft
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    <div class="flex items-center space-x-2">
                                        <button class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300" title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if entry.status != 'POSTED' %}
                                        <button class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300" title="Post">
                                            <i class="fas fa-clipboard-check"></i>
                                        </button>
                                        {% else %}
                                        <button class="text-orange-600 dark:text-orange-400 hover:text-orange-800 dark:hover:text-orange-300" title="Reverse">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        {% endif %}
                                        <button class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Entry Lines Expandable -->
                            <tr class="hidden bg-gray-50 dark:bg-gray-750">
                                <td colspan="8" class="px-6 py-4">
                                    <div class="space-y-2">
                                        <div class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">Entry Lines:</div>
                                        {% for line in entry.lines.all %}
                                        <div class="flex justify-between items-center text-sm py-1">
                                            <div class="flex items-center space-x-4">
                                                <span class="text-gray-600 dark:text-gray-400">{{ line.account.code }}</span>
                                                <span class="text-gray-900 dark:text-gray-100">{{ line.account.name }}</span>
                                                {% if line.description %}
                                                <span class="text-gray-500 dark:text-gray-500 text-xs">- {{ line.description }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="flex space-x-6">
                                                <span class="text-gray-900 dark:text-gray-100 font-medium w-24 text-right">
                                                    {% if line.debit_amount > 0 %}${{ line.debit_amount|floatformat:2 }}{% endif %}
                                                </span>
                                                <span class="text-gray-900 dark:text-gray-100 font-medium w-24 text-right">
                                                    {% if line.credit_amount > 0 %}${{ line.credit_amount|floatformat:2 }}{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% if entry.memo %}
                                        <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-400">
                                            <strong>Memo:</strong> {{ entry.memo }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-book text-4xl mb-2 text-gray-300 dark:text-gray-600"></i>
                                        <p>No journal entries found. Create your first entry to get started.</p>
                                        <button class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                            <i class="fas fa-plus mr-2"></i>
                                            New Journal Entry
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if journal_entries %}
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            Showing {{ journal_entries|length }} of {{ total_entries }} entries
                        </div>
                        <div class="flex space-x-2">
                            <button class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700">
                                Previous
                            </button>
                            <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm">1</button>
                            <button class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Balance Check -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-bold text-gray-900 dark:text-gray-100">Balance Check</h4>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Total Debits</span>
                            <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${{ total_debits|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Total Credits</span>
                            <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${{ total_credits|floatformat:2 }}</span>
                        </div>
                        <hr class="border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-900 dark:text-gray-100">Difference</span>
                            {% if total_debits == total_credits %}
                            <span class="text-sm font-bold text-green-600 dark:text-green-400">
                                <i class="fas fa-check-circle mr-1"></i>Balanced
                            </span>
                            {% else %}
                            <span class="text-sm font-bold text-red-600 dark:text-red-400">
                                <i class="fas fa-exclamation-triangle mr-1"></i>${{ total_debits|add:"-"|add:total_credits|floatformat:2 }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-bold text-gray-900 dark:text-gray-100">Recent Entries</h4>
                    </div>
                    <div class="p-6 space-y-4">
                        {% for entry in recent_entries|slice:":5" %}
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-{% if entry.status == 'POSTED' %}green{% else %}yellow{% endif %}-100 dark:bg-{% if entry.status == 'POSTED' %}green{% else %}yellow{% endif %}-900 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-{% if entry.status == 'POSTED' %}check{% else %}edit{% endif %} text-{% if entry.status == 'POSTED' %}green{% else %}yellow{% endif %}-600 dark:text-{% if entry.status == 'POSTED' %}green{% else %}yellow{% endif %}-400 text-xs"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100">JE-{{ entry.id|stringformat:"04d" }}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400">{{ entry.status }} â€¢ ${{ entry.total_debit|floatformat:0 }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-500">{{ entry.entry_date|timesince }} ago</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No recent entries</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Entry Types -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-bold text-gray-900 dark:text-gray-100">Entry Status</h4>
                    </div>
                    <div class="p-6 space-y-3">
                        {% for status_data in status_distribution %}
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-{% if status_data.status == 'POSTED' %}green{% elif status_data.status == 'DRAFT' %}yellow{% else %}gray{% endif %}-500 rounded-full"></div>
                                <span class="text-sm text-gray-900 dark:text-gray-100">{{ status_data.status }}</span>
                            </div>
                            <span class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ status_data.count }}</span>
                        </div>
                        {% empty %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No entries</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Tools -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-bold text-gray-900 dark:text-gray-100">Quick Tools</h4>
                    </div>
                    <div class="p-6 space-y-3">
                        <!-- TODO: Implement these reports -->
                        {% comment %}
                        <a href="{% url 'journal_report' %}" class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm">
                            <i class="fas fa-file-alt mr-2"></i>
                            Journal Report
                        </a>
                        <a href="{% url 'trial_balance' %}" class="w-full flex items-center justify-center px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm">
                            <i class="fas fa-balance-scale mr-2"></i>
                            Trial Balance
                        </a>
                        <a href="{% url 'reconciliation' %}" class="w-full flex items-center justify-center px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors duration-200 text-sm">
                            <i class="fas fa-calculator mr-2"></i>
                            Reconciliation
                        </a>
                        {% endcomment %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
                            Reports coming soon
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Theme Toggle Script -->
<script>
    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        });
    }
    
    // Initialize theme
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    }
    
    // Toggle entry details (expandable rows)
    document.querySelectorAll('tbody tr:not(.hidden)').forEach((row, index) => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', (e) => {
            // Don't toggle if clicking action buttons
            if (e.target.closest('button')) return;
            
            const detailRow = row.nextElementSibling;
            if (detailRow && detailRow.classList.contains('hidden')) {
                detailRow.classList.toggle('hidden');
            }
        });
    });

    // New Entry Modal
    const newEntryBtns = document.querySelectorAll('#new-entry-btn, #new-entry-action-btn');
    const newEntryModal = document.createElement('div');
    newEntryModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
    newEntryModal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">New Journal Entry</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <form id="new-entry-form" class="p-6 space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Entry Date</label>
                        <input type="date" name="entry_date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reference</label>
                        <input type="text" name="reference" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                    <input type="text" name="description" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Memo</label>
                    <textarea name="memo" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></textarea>
                </div>
                
                <!-- Journal Lines -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Journal Lines</h4>
                        <button type="button" id="add-line-btn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-1"></i>Add Line
                        </button>
                    </div>
                    <div id="journal-lines" class="space-y-3">
                        <div class="journal-line grid grid-cols-12 gap-3 items-end">
                            <div class="col-span-3">
                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Account</label>
                                <select name="account[]" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="">Select Account</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.code }}">{{ account.code }} - {{ account.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-span-3">
                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Description</label>
                                <input type="text" name="line_description[]" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Debit</label>
                                <input type="number" name="debit[]" step="0.01" min="0" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 debit-input">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Credit</label>
                                <input type="number" name="credit[]" step="0.01" min="0" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 credit-input">
                            </div>
                            <div class="col-span-2">
                                <button type="button" class="remove-line-btn px-2 py-2 text-red-600 hover:text-red-800 disabled:opacity-50" disabled>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Balance Check -->
                <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-900 dark:text-gray-100">Total Debits: $<span id="total-debits">0.00</span></span>
                        <span class="font-medium text-gray-900 dark:text-gray-100">Total Credits: $<span id="total-credits">0.00</span></span>
                        <span class="font-bold" id="balance-status">Balanced</span>
                    </div>
                </div>
            </form>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal">Cancel</button>
                <button type="submit" form="new-entry-form" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Entry</button>
            </div>
        </div>
    `;
    document.body.appendChild(newEntryModal);

    // Reverse Entry Modal
    const reverseEntryModal = document.createElement('div');
    reverseEntryModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
    reverseEntryModal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Reverse Journal Entry</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <form id="reverse-entry-form" class="p-6 space-y-4">
                {% csrf_token %}
                <input type="hidden" name="entry_id" id="reverse-entry-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reverse Date</label>
                    <input type="date" name="reverse_date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reason for Reversal</label>
                    <textarea name="reason" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></textarea>
                </div>
            </form>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal">Cancel</button>
                <button type="submit" form="reverse-entry-form" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Reverse Entry</button>
            </div>
        </div>
    `;
    document.body.appendChild(reverseEntryModal);

    // Event Listeners
    newEntryBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            newEntryModal.classList.remove('hidden');
        });
    });

    document.getElementById('reverse-entry-btn').addEventListener('click', () => {
        const selectedEntries = document.querySelectorAll('input[name="entry_select"]:checked');
        if (selectedEntries.length !== 1) {
            alert('Please select exactly one posted entry to reverse.');
            return;
        }
        const entryId = selectedEntries[0].value;
        document.getElementById('reverse-entry-id').value = entryId;
        reverseEntryModal.classList.remove('hidden');
    });

    document.getElementById('post-entries-btn').addEventListener('click', () => {
        alert('Post entries feature coming soon!');
        // TODO: Implement post_journal_entries URL and view
    });

    document.getElementById('export-btn').addEventListener('click', () => {
        alert('Export feature coming soon!');
        // TODO: Implement export_journal_entries URL and view
    });

    // Close modals
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            newEntryModal.classList.add('hidden');
            reverseEntryModal.classList.add('hidden');
        });
    });

    // Add journal line functionality
    let lineCount = 1;
    document.getElementById('add-line-btn').addEventListener('click', () => {
        lineCount++;
        const linesContainer = document.getElementById('journal-lines');
        const newLine = document.createElement('div');
        newLine.className = 'journal-line grid grid-cols-12 gap-3 items-end';
        newLine.innerHTML = `
            <div class="col-span-3">
                <select name="account[]" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <option value="">Select Account</option>
                    {% for account in accounts %}
                    <option value="{{ account.code }}">{{ account.code }} - {{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-span-3">
                <input type="text" name="line_description[]" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
            </div>
            <div class="col-span-2">
                <input type="number" name="debit[]" step="0.01" min="0" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 debit-input">
            </div>
            <div class="col-span-2">
                <input type="number" name="credit[]" step="0.01" min="0" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 credit-input">
            </div>
            <div class="col-span-2">
                <button type="button" class="remove-line-btn px-2 py-2 text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        linesContainer.appendChild(newLine);
        updateBalance();
    });

    // Remove line functionality
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-line-btn') || e.target.closest('.remove-line-btn')) {
            const line = e.target.closest('.journal-line');
            if (document.querySelectorAll('.journal-line').length > 1) {
                line.remove();
                updateBalance();
            }
        }
    });

    // Update balance calculation
    function updateBalance() {
        let totalDebits = 0;
        let totalCredits = 0;
        
        document.querySelectorAll('.debit-input').forEach(input => {
            totalDebits += parseFloat(input.value) || 0;
        });
        
        document.querySelectorAll('.credit-input').forEach(input => {
            totalCredits += parseFloat(input.value) || 0;
        });
        
        document.getElementById('total-debits').textContent = totalDebits.toFixed(2);
        document.getElementById('total-credits').textContent = totalCredits.toFixed(2);
        
        const balanceStatus = document.getElementById('balance-status');
        if (Math.abs(totalDebits - totalCredits) < 0.01) {
            balanceStatus.textContent = 'Balanced';
            balanceStatus.className = 'font-bold text-green-600';
        } else {
            balanceStatus.textContent = 'Not Balanced';
            balanceStatus.className = 'font-bold text-red-600';
        }
    }

    document.addEventListener('input', (e) => {
        if (e.target.classList.contains('debit-input') || e.target.classList.contains('credit-input')) {
            updateBalance();
        }
    });

    // Form submissions
    document.getElementById('new-entry-form').addEventListener('submit', (e) => {
        e.preventDefault();
        alert('Create journal entry feature coming soon!');
        // TODO: Implement create_journal_entry URL and view
    });

    document.getElementById('reverse-entry-form').addEventListener('submit', (e) => {
        e.preventDefault();
        alert('Reverse entry feature coming soon!');
        // TODO: Implement reverse_journal_entry URL and view
    });

    // Add checkboxes for entry selection
    document.querySelectorAll('tbody tr:not(.hidden)').forEach((row, index) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'entry_select';
        checkbox.value = row.querySelector('td a').textContent.replace('JE-', '');
        checkbox.className = 'mr-2';
        
        const firstCell = row.querySelector('td');
        firstCell.insertBefore(checkbox, firstCell.firstChild);
    });
</script>

{% endblock %}