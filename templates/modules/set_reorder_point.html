{% extends 'base.html' %} {% load static %} {% block content %} {% include
'components/sidemenu.html' %}

<div
  class="min-h-screen bg-gray-50 dark:bg-gray-900 ml-64 transition-colors duration-300"
>
  <!-- Header -->
  <div
    class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 transition-colors duration-300"
  >
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button
          onclick="window.history.back()"
          class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
        >
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
          Set Reorder Points
        </h1>
      </div>
      <div class="flex items-center space-x-4">
        <button
          id="save-all"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700"
        >
          <i class="fas fa-save mr-2"></i>Save All Changes
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-8">
    <!-- Instructions -->
    <div
      class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-2xl p-6 mb-6"
    >
      <h3 class="text-lg font-bold text-blue-900 dark:text-blue-100 mb-2">
        Reorder Point Management
      </h3>
      <div class="text-sm text-blue-800 dark:text-blue-200 space-y-1">
        <p>
          • Set reorder points to automatically trigger purchase orders when
          stock gets low
        </p>
        <p>• Minimum stock is the absolute minimum you should have on hand</p>
        <p>• Reorder point is when you should start the ordering process</p>
        <p>• Maximum stock helps prevent overstocking (optional)</p>
      </div>
    </div>

    <!-- Items Table -->
    <div
      class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"
    >
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">
          Inventory Items
        </h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Item Code
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Name
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Category
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Current Stock
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Min Stock
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Reorder Point
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Max Stock
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Status
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
          >
            {% for item in items %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td
                class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100"
              >
                {{ item.item_code }}
              </td>
              <td
                class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100"
              >
                {{ item.name }}
              </td>
              <td
                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400"
              >
                {{ item.category.name|default:"Uncategorized" }}
              </td>
              <td
                class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100"
              >
                {{ item.current_stock }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input
                  type="number"
                  class="min-stock-input w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm"
                  value="{{ item.minimum_stock|default:0 }}"
                  min="0"
                  step="0.01"
                  data-item-id="{{ item.id }}"
                />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input
                  type="number"
                  class="reorder-point-input w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm"
                  value="{{ item.reorder_point|default:0 }}"
                  min="0"
                  step="0.01"
                  data-item-id="{{ item.id }}"
                />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <input
                  type="number"
                  class="max-stock-input w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm"
                  value="{{ item.maximum_stock|default:'' }}"
                  min="0"
                  step="0.01"
                  placeholder="Optional"
                  data-item-id="{{ item.id }}"
                />
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if item.current_stock <= item.reorder_point %}
                <span
                  class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"
                >
                  Needs Reorder
                </span>
                {% elif item.maximum_stock and item.current_stock >=
                item.maximum_stock %}
                <span
                  class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"
                >
                  Overstock
                </span>
                {% else %}
                <span
                  class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"
                >
                  OK
                </span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button
                  class="save-item-btn px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700"
                  data-item-id="{{ item.id }}"
                >
                  Save
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td
                colspan="9"
                class="px-6 py-4 text-center text-gray-500 dark:text-gray-400"
              >
                No inventory items found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div
      class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mt-6"
    >
      <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">
        Bulk Actions
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Set All Reorder Points to:</label
          >
          <input
            type="number"
            id="bulk-reorder-point"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            placeholder="10"
            min="0"
            step="0.01"
          />
        </div>
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Set All Min Stock to:</label
          >
          <input
            type="number"
            id="bulk-min-stock"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            placeholder="5"
            min="0"
            step="0.01"
          />
        </div>
        <div class="flex items-end">
          <button
            id="apply-bulk"
            class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700"
          >
            <i class="fas fa-check mr-2"></i>Apply to All
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Save individual item
  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("save-item-btn")) {
      const itemId = e.target.getAttribute("data-item-id");
      const row = e.target.closest("tr");

      const reorderPoint = row.querySelector(".reorder-point-input").value;
      const minimumStock = row.querySelector(".min-stock-input").value;
      const maximumStock = row.querySelector(".max-stock-input").value;

      try {
        const response = await fetch("{% url 'set_reorder_point' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: new URLSearchParams({
            item_id: itemId,
            reorder_point: reorderPoint,
            minimum_stock: minimumStock,
            maximum_stock: maximumStock,
          }),
        });

        const result = await response.json();
        if (result.success) {
          // Update status
          const statusCell = row.querySelector("td:nth-child(8)");
          const currentStock = parseFloat(
            row.querySelector("td:nth-child(4)").textContent
          );
          const reorderPointNum = parseFloat(reorderPoint);
          const maxStockNum = maximumStock ? parseFloat(maximumStock) : null;

          let statusHtml = "";
          if (currentStock <= reorderPointNum) {
            statusHtml =
              '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Needs Reorder</span>';
          } else if (maxStockNum && currentStock >= maxStockNum) {
            statusHtml =
              '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Overstock</span>';
          } else {
            statusHtml =
              '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">OK</span>';
          }
          statusCell.innerHTML = statusHtml;

          alert(result.message);
        } else {
          alert("Error: " + result.error);
        }
      } catch (error) {
        alert("Error saving reorder point: " + error.message);
      }
    }
  });

  // Save all changes
  document.getElementById("save-all").addEventListener("click", async () => {
    const promises = [];
    const rows = document.querySelectorAll("tbody tr");

    rows.forEach((row) => {
      const itemId = row
        .querySelector(".save-item-btn")
        .getAttribute("data-item-id");
      const reorderPoint = row.querySelector(".reorder-point-input").value;
      const minimumStock = row.querySelector(".min-stock-input").value;
      const maximumStock = row.querySelector(".max-stock-input").value;

      const promise = fetch("{% url 'set_reorder_point' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: new URLSearchParams({
          item_id: itemId,
          reorder_point: reorderPoint,
          minimum_stock: minimumStock,
          maximum_stock: maximumStock,
        }),
      });

      promises.push(promise);
    });

    try {
      const responses = await Promise.all(promises);
      let successCount = 0;
      let errorCount = 0;

      for (const response of responses) {
        const result = await response.json();
        if (result.success) {
          successCount++;
        } else {
          errorCount++;
        }
      }

      alert(
        `Saved ${successCount} items successfully${
          errorCount > 0 ? `, ${errorCount} errors` : ""
        }`
      );
      if (successCount > 0) {
        location.reload();
      }
    } catch (error) {
      alert("Error saving changes: " + error.message);
    }
  });

  // Apply bulk settings
  document.getElementById("apply-bulk").addEventListener("click", () => {
    const bulkReorderPoint =
      document.getElementById("bulk-reorder-point").value;
    const bulkMinStock = document.getElementById("bulk-min-stock").value;

    if (!bulkReorderPoint && !bulkMinStock) {
      alert("Please enter values for bulk update");
      return;
    }

    if (!confirm("This will update all items. Are you sure?")) {
      return;
    }

    document.querySelectorAll(".reorder-point-input").forEach((input) => {
      if (bulkReorderPoint) input.value = bulkReorderPoint;
    });

    document.querySelectorAll(".min-stock-input").forEach((input) => {
      if (bulkMinStock) input.value = bulkMinStock;
    });
  });
</script>

{% endblock %}
