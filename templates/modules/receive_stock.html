{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'components/sidemenu.html' %}

<div
  class="min-h-screen bg-gray-50 dark:bg-gray-900 ml-64 transition-colors duration-300"
>
  <!-- Header -->
  <div
    class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 transition-colors duration-300"
  >
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button
          onclick="window.history.back()"
          class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
        >
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
          Receive Stock
        </h1>
      </div>
    </div>
  </div>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-8">
    <form id="receive-stock-form" class="space-y-6">
      <!-- Stock Receipt Details -->
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
      >
        <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">
          Stock Receipt Details
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Select Item *</label
            >
            <select
              id="item-select"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              required
            >
              <option value="">Select Item</option>
              {% for item in items %}
              <option value="{{ item.id }}" data-current-stock="{{ item.current_stock }}">
                {{ item.item_code }} - {{ item.name }} (Current: {{ item.current_stock }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Quantity Received *</label
            >
            <input
              type="number"
              id="quantity"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              placeholder="0.00"
              step="0.01"
              min="0.01"
              required
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Unit Cost *</label
            >
            <input
              type="number"
              id="unit-cost"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              placeholder="0.00"
              step="0.01"
              min="0.01"
              required
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Vendor</label
            >
            <select
              id="vendor-select"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            >
              <option value="">Select Vendor (Optional)</option>
              {% for vendor in vendors %}
              <option value="{{ vendor.id }}">
                {{ vendor.company_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Reference Number</label
            >
            <input
              type="text"
              id="reference-number"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              placeholder="PO-12345 or INV-001"
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Receipt Date</label
            >
            <input
              type="date"
              id="receipt-date"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              value="{% now 'Y-m-d' %}"
            />
          </div>
        </div>
        <div class="mt-4">
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Notes</label
          >
          <textarea
            id="notes"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            placeholder="Additional notes about this stock receipt..."
          ></textarea>
        </div>
      </div>

      <!-- Stock Summary -->
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
      >
        <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">
          Stock Summary
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="current-stock">
              --
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Current Stock
            </div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600" id="new-stock">
              --
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
              New Stock Level
            </div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600" id="total-value">
              $--
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Total Value
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-4">
        <button
          type="button"
          onclick="window.history.back()"
          class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700"
        >
          Cancel
        </button>
        <button
          type="button"
          id="receive-stock"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700"
        >
          <i class="fas fa-plus mr-2"></i>Receive Stock
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let selectedItem = null;

  // Update stock summary when item is selected
  document.getElementById("item-select").addEventListener("change", (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const currentStock = parseFloat(selectedOption.getAttribute("data-current-stock")) || 0;

    selectedItem = {
      id: e.target.value,
      currentStock: currentStock
    };

    document.getElementById("current-stock").textContent = currentStock.toFixed(2);
    updateSummary();
  });

  // Update summary when quantity or cost changes
  document.getElementById("quantity").addEventListener("input", updateSummary);
  document.getElementById("unit-cost").addEventListener("input", updateSummary);

  function updateSummary() {
    if (!selectedItem) return;

    const quantity = parseFloat(document.getElementById("quantity").value) || 0;
    const unitCost = parseFloat(document.getElementById("unit-cost").value) || 0;

    const newStock = selectedItem.currentStock + quantity;
    const totalValue = newStock * unitCost;

    document.getElementById("new-stock").textContent = newStock.toFixed(2);
    document.getElementById("total-value").textContent = "$" + totalValue.toFixed(2);
  }

  // Form submission
  document
    .getElementById("receive-stock")
    .addEventListener("click", async () => {
      const formData = {
        item_id: document.getElementById("item-select").value,
        quantity: document.getElementById("quantity").value,
        unit_cost: document.getElementById("unit-cost").value,
        vendor: document.getElementById("vendor-select").value,
        reference_number: document.getElementById("reference-number").value,
        notes: document.getElementById("notes").value,
      };

      // Validation
      if (!formData.item_id) {
        alert("Please select an item");
        return;
      }

      if (!formData.quantity || parseFloat(formData.quantity) <= 0) {
        alert("Please enter a valid quantity");
        return;
      }

      if (!formData.unit_cost || parseFloat(formData.unit_cost) <= 0) {
        alert("Please enter a valid unit cost");
        return;
      }

      try {
        const response = await fetch("{% url 'receive_stock' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: new URLSearchParams(formData),
        });

        const result = await response.json();
        if (result.success) {
          alert(result.message);
          window.location.href = "{% url 'inventory' %}";
        } else {
          alert("Error: " + result.error);
        }
      } catch (error) {
        alert("Error receiving stock: " + error.message);
      }
    });
</script>

{% endblock %}